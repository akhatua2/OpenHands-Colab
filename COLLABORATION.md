# 🤝 OpenHands Multi-Agent Collaboration System

## 📋 Overview

This project demonstrates a **functional multi-agent collaboration system** for OpenHands using the Model Context Protocol (MCP). Two AI agents work in parallel on a shared codebase, coordinating through real-time message passing while maintaining their own execution contexts.

## 🎯 What We Built

### **Core System Components:**
- **MCP Server** (`mcp_server.py`) - Handles inter-agent messaging with persistent storage
- **Agent Controller Integration** - Modified OpenHands to automatically inject agent IDs and fetch messages
- **System Prompt Enhancement** - Updated agents to understand collaboration protocols
- **Dual Agent Configuration** - Two agents working in shared workspace with unique identities

### **Successful Demonstration:**
✅ **Agent 1** created a complete `Calculator` class with arithmetic operations
✅ **Agent 2** developed comprehensive unit tests for the calculator
✅ **Real-time coordination** through MCP message passing
✅ **Shared workspace** where both agents can see each other's work
✅ **Automatic agent ID injection** for seamless communication

## 🔧 Technical Implementation

### **Key Files Modified:**
- `openhands/controller/agent_controller.py` - Added collaboration features
- `openhands/agenthub/codeact_agent/prompts/system_prompt.j2` - Enhanced with collaboration protocols
- `config.agent1.toml` & `config.agent2.toml` - Agent configurations
- `mcp_server.py` - MCP collaboration server

### **MCP Integration Details:**
OpenHands automatically prefixes MCP tool names with the server name, so:
- MCP Server provides: `send` and `get_messages`
- Agents see: `collaboration_send` and `collaboration_get_messages`
- System automatically injects `agent_id` parameter from environment variables

## 📊 Trajectory Analysis - MCP Usage Evidence

### **Agent 1 (Calculator Implementation) - MCP Activity:**

**1. Initial Status Broadcast:**
```json
{
  "action": "call_tool_mcp",
  "function_name": "collaboration_send",
  "arguments": {
    "message": "Agent 1: Starting calculator on branch 1 - creating Calculator class",
    "agent_id": "1"
  }
}
```

**2. Progress Updates:**
```json
{
  "action": "call_tool_mcp",
  "function_name": "collaboration_send",
  "arguments": {
    "message": "Implemented add(a,b), subtract(a,b), multiply(a,b), divide(a,b) methods",
    "agent_id": "1"
  }
}
```

**3. Feature Completion:**
```json
{
  "action": "call_tool_mcp",
  "function_name": "collaboration_send",
  "arguments": {
    "message": "Added division by zero error handling",
    "agent_id": "1"
  }
}
```

**4. Final Status:**
```json
{
  "action": "call_tool_mcp",
  "function_name": "collaboration_send",
  "arguments": {
    "message": "Calculator class complete with all arithmetic functions - ready for testing",
    "agent_id": "1"
  }
}
```

### **Agent 2 (Test Development) - MCP Activity:**

Agent 2 successfully created comprehensive unit tests including:
- Basic arithmetic operation tests
- Edge case handling (division by zero)
- Negative number calculations
- Error condition validation

**Key Coordination Features Demonstrated:**
- ✅ **Automatic Agent ID Injection** - System automatically added `"agent_id": "1"` to all MCP calls
- ✅ **Real-time Message Broadcasting** - Messages immediately available to other agents
- ✅ **Non-blocking Communication** - Agents continued working while sending updates
- ✅ **Shared Workspace Coordination** - Both agents worked in `workspace1/` directory

## 🚀 How to Run the System

### **Prerequisites:**
```bash
# Install dependencies
poetry install

# Set your OpenAI API key
export OPENAI_API_KEY="your-api-key-here"
```

### **1. Start the MCP Server:**
```bash
python mcp_server.py
```

### **2. Run Dual-Agent Collaboration:**
```bash
chmod +x run_collaboration_demo.sh
./run_collaboration_demo.sh
```

### **3. Monitor Real-time Collaboration:**
- **Agent Logs**: Check `logs/` directory for detailed execution trajectories
- **MCP Server Logs**: Monitor `mcp_server.log` for message passing activity
- **Workspace Output**: View `workspace1/` for generated code and tests

## 📁 Project Structure

```
OpenHands-Colab/
├── mcp_server.py              # MCP collaboration server
├── config.agent1.toml         # Agent 1 configuration
├── config.agent2.toml         # Agent 2 configuration
├── run_collaboration_demo.sh  # Demo execution script
├── workspace1/                # Shared agent workspace
│   ├── calculator.py          # Generated by Agent 1
│   └── test_calculator.py     # Generated by Agent 2
├── logs/                      # Agent execution trajectories
└── openhands/                 # Modified OpenHands core
    ├── controller/agent_controller.py    # Collaboration integration
    └── agenthub/codeact_agent/prompts/   # Enhanced prompts
```

## 🔍 System Architecture

### **Message Flow:**
1. **Agent 1** calls `collaboration_send(message)`
2. **OpenHands** automatically injects `agent_id: "1"`
3. **MCP Server** stores message with sender identification
4. **Agent 2** automatically fetches unread messages at each turn
5. **Messages appear** in Agent 2's context for coordination

### **Key Technical Insights:**
- **MCP Tool Naming**: OpenHands prefixes tools with server name (`collaboration_send`)
- **Agent ID Injection**: Environment variables (`AGENT_ID`) automatically injected by controller
- **Shared Workspace**: Both agents work in same directory via volume mounting
- **Non-blocking Design**: Agents continue execution while messages propagate

## 🎉 Results

### **Generated Artifacts:**

**`workspace1/calculator.py`** (by Agent 1):
- Complete Calculator class with add, subtract, multiply, divide
- Proper error handling for division by zero
- Clean, minimal implementation

**`workspace1/test_calculator.py`** (by Agent 2):
- Comprehensive unittest suite
- Tests for all arithmetic operations
- Edge case validation (negative numbers, zero division)
- Proper error condition testing

### **Collaboration Metrics:**
- **4 MCP messages** sent by Agent 1 with detailed progress updates
- **Automatic agent coordination** without manual intervention
- **Zero conflicts** in shared workspace development
- **Complete feature delivery** with implementation + tests

## 🎯 Benefits Demonstrated

✅ **Real-time Coordination** - Agents stay informed of each other's progress
✅ **Conflict Prevention** - Clear communication prevents duplicate work
✅ **Parallel Development** - Multiple agents work simultaneously
✅ **Standards-based** - Uses MCP protocol for clean integration
✅ **Minimal Code Changes** - Small modifications to OpenHands core
✅ **Scalable Design** - Easy to add more agents or capabilities

## 🔮 Future Enhancements

- **Multi-workspace Support** - Agents in separate Git branches
- **Message Persistence** - Database storage for message history
- **Agent Discovery** - Dynamic agent registration and discovery
- **Task Assignment** - Intelligent work distribution between agents
- **Integration Testing** - Automated coordination verification

---

This collaboration system proves that AI agents can effectively coordinate complex development tasks using standards-based protocols, opening new possibilities for AI-assisted software development workflows.
